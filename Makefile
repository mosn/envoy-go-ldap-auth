.PHONY: build build-local run test
build:
	docker run --rm -v `pwd`:/go/src/go-filter -w /go/src/go-filter \
		-e GOPROXY=https://goproxy.cn \
		golang:1.19 \
		go build -v -o libgolang.so -buildmode=c-shared -buildvcs=false .

build-local:
	GOPROXY=https://goproxy.cn go build -v -o libgolang.so -buildmode=c-shared .

run:
	docker run --rm -v `pwd`/envoy.yaml:/etc/envoy/envoy.yaml \
		-v `pwd`/libgolang.so:/etc/envoy/libgolang.so \
		-e "GODEBUG=cgocheck=0" \
		-p 10000:10000 \
		envoyproxy/envoy:contrib-v1.26.1 \
		envoy -c /etc/envoy/envoy.yaml

test-run:
	docker run --rm -v `pwd`/example/envoy.yaml:/etc/envoy/envoy.yaml \
		-v `pwd`/libgolang.so:/etc/envoy/libgolang.so \
		-p 10000:10000 \
		envoyproxy/envoy:contrib-dev \
		envoy -c /etc/envoy/envoy.yaml

test:
	curl -s -I 'http://localhost:10000/'
	curl -s -I 'http://localhost:10000/' -H 'Authorization: Basic dW5rbm93bjpkb2dvb2Q=' # generated by `echo -n "unknown:dogood" | base64`
	curl -s -I 'http://localhost:10000/' -H 'Authorization: Basic aGFja2Vyczp1bmtub3du' # generated by `echo -n "hackers:unknown" | base64`
	curl -s -I 'http://localhost:10000/' -H 'Authorization: Basic aGFja2Vyczpkb2dvb2Q=' # generated by `echo -n "hackers:dogood" | base64`
